{{define "content"}}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{if eq .action "create"}}新增令牌{{else}}編輯令牌{{end}}</h1>
</div>

{{if .error}}
<div class="alert alert-danger" role="alert">
    {{.error}}
</div>
{{end}}

<div class="row">
    <div class="col-md-6">
        <form method="POST">
            <div class="mb-3">
                <label for="person_id" class="form-label">人員</label>
                <select class="form-select" id="person_id" name="person_id" required>
                    <option value="">請選擇人員</option>
                    {{range .persons}}
                    <option value="{{.ID}}" {{if and $.token (eq $.token.PersonID .ID)}}selected{{end}}>
                        {{.Name}} ({{.Email}})
                    </option>
                    {{end}}
                </select>
            </div>

            <div class="mb-3">
                <label for="service_id" class="form-label">服務</label>
                <select class="form-select" id="service_id" name="service_id" required>
                    <option value="">請選擇服務</option>
                    {{range .services}}
                    <option value="{{.ID}}" {{if and $.token (eq $.token.ServiceID .ID)}}selected{{end}}>
                        {{.Name}} ({{.URL}})
                    </option>
                    {{end}}
                </select>
            </div>

            <div class="mb-3">
                <label for="expire_at" class="form-label">到期日期</label>
                <input type="date" class="form-control" id="expire_at" name="expire_at" required
                    value="{{if .token}}{{.token.ExpireAt.Format " 2006-01-02"}}{{end}}">
                <div class="form-text">令牌到期後將無法使用，請設置適當的到期日期</div>
            </div>

            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="active" name="active" value="true" {{if or (not
                    .token) (.token.IsActive)}}checked{{end}}>
                <label class="form-check-label" for="active">啟用</label>
            </div>

            <div class="d-grid gap-2 d-md-flex">
                <button type="submit" class="btn btn-primary">保存</button>
                <a href="/admin/tokens" class="btn btn-outline-secondary">取消</a>
            </div>
        </form>
    </div>
</div>
{{end}}

{{define "js"}}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 如果是新增令牌，設置默認到期日期為一年後
        if (!document.getElementById('expire_at').value) {
            const today = new Date();
            const nextYear = new Date(today.setFullYear(today.getFullYear() + 1));
            const dateString = nextYear.toISOString().substring(0, 10);
            document.getElementById('expire_at').value = dateString;
        }
    });
</script>
{{end}}